<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, width=device-width" />
<link rel="stylesheet" type="text/css" href="https://js.cit.api.here.com/v3/3.0/mapsjs-ui.css?dp-version=1526040296" />
<script type="text/javascript" src="https://js.cit.api.here.com/v3/3.0/mapsjs-core.js"></script>
<script type="text/javascript" src="https://js.cit.api.here.com/v3/3.0/mapsjs-service.js"></script>
<script type="text/javascript" src="https://js.cit.api.here.com/v3/3.0/mapsjs-ui.js"></script>
<script type="text/javascript" src="https://js.cit.api.here.com/v3/3.0/mapsjs-mapevents.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="Chart.bundle.min.js"></script>
<script src="drawGraph.js"></script>
<style>
.kc_fab_main_btn{
  background-color:#F44336;
  width:60px;
  height:60px;
  border-radius:100%;
  background:#000000;
  border:none;
  outline:none;
  color:#FFF;
  font-size:24px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
  transition:.3s;  
  -webkit-tap-highlight-color: rgba(0,0,0,0);
}

</style>
</head>
<body>
  <button 
    id="start"
    style="position:absolute; right:0%; z-index:1001; margin:10px"
    class="kc_fab_main_btn"
    onclick="onClose()">x</button>
  <div id="map" style="position:absolute; width:99%; height:68%; background:grey; margin:5px" ></div>
  <div style="position:absolute; top:70%; width:99%; height:28%; margin:5px"><canvas id="canvas" ></canvas></div>
  <script  type="text/javascript" charset="UTF-8" >


/**
 * Calculates and displays a car route from the Brandenburg Gate in the centre of Berlin
 * to Friedrichstra√üe Railway Station.
 *
 * A full list of available request parameters can be found in the Routing API documentation.
 * see:  http://developer.here.com/rest-apis/documentation/routing/topics/resource-calculate-route.html
 *
 * @param   {H.service.Platform} platform    A stub class to access HERE services
 */
function calculateRouteFromAtoB (platform, routeCoords) {
  var router = platform.getRoutingService(),
    routeRequestParams = {
      mode: 'fastest;car',
      representation: 'display',
      routeattributes : 'waypoints,summary,shape,legs',
      maneuverattributes: 'direction,action',
      waypoint0: routeCoords[0], 
      waypoint1: routeCoords[1] 
    };

  router.calculateRoute(
    routeRequestParams,
    onSuccess,
    onError
  );
}
/**
 * This function will be called once the Routing REST API provides a response
 * @param  {Object} result          A JSONP object representing the calculated route
 *
 * see: http://developer.here.com/rest-apis/documentation/routing/topics/resource-type-calculate-route.html
 */
function onSuccess(result) {
  var route = result.response.route[0];
  var coords = transformCoordinates(route.shape);
  getAltitude(coords, route.summary.distance);
 /*
  * The styling of the route response on the map is entirely under the developer's control.
  * A representitive styling can be found the full JS + HTML code of this example
  * in the functions below:
  */
  addRouteShapeToMap(route);
  //addManueversToMap(route);

  // addWaypointsToPanel(route.waypoint);
  // addManueversToPanel(route);
  // addSummaryToPanel(route.summary);
  // ... etc.
}

/**
 * This function will be called if a communication error occurs during the JSON-P request
 * @param  {Object} error  The error message received.
 */
function onError(error) {
  alert('Ooops!');
}

function onClose() {
  removeObjectById('route');
  //document.getElementById('map').style="position:absolute; width:99%; height:99%; z-index:90; background:grey"
  tapCounter = 0;
}



/**
 * Boilerplate map initialization code starts below:
 */

// set up containers for the map  + panel
var mapContainer = document.getElementById('map');

//Step 1: initialize communication with the platform
var platform = new H.service.Platform({
  app_id: 'DemoAppId01082013GAL',
  app_code: 'AJKnXv84fjrb0KIHawS0Tg',
  useCIT: true,
  useHTTPS: true
});
var pixelRatio = window.devicePixelRatio || 1;
var defaultLayers = platform.createDefaultLayers({
  tileSize: pixelRatio === 1 ? 256 : 512,
  ppi: pixelRatio === 1 ? undefined : 320
});

//Step 2: initialize a map - this map is centered over Berlin
var map = new H.Map(mapContainer,
  defaultLayers.normal.map,{
  center: {lat:45.05, lng:41.95},
  zoom: 12,
  pixelRatio: pixelRatio
});

var tapCounter = 0;
var routeCoords = [0,0];
lines = [];
map.addEventListener('tap', function (evt) {
  var coord = map.screenToGeo(evt.currentPointer.viewportX,
            evt.currentPointer.viewportY);
  if (tapCounter === 0) {
    routeCoords[0] = coord.lat.toString()+','+coord.lng.toString();
  } else if (tapCounter === 1) {
    routeCoords[1] = coord.lat.toString()+','+coord.lng.toString();
    console.log(routeCoords);
    calculateRouteFromAtoB(platform, routeCoords);
  }
  tapCounter += 1;
  console.log(tapCounter);
});

//Step 3: make the map interactive
// MapEvents enables the event system
// Behavior implements default interactions for pan/zoom (also on mobile touch environments)
var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

// Create the default UI components
var ui = H.ui.UI.createDefault(map, defaultLayers);

// Hold a reference to any infobubble opened
// var bubble;

/**
 * Opens/Closes a infobubble
 * @param  {H.geo.Point} position     The location on the map.
 * @param  {String} text              The contents of the infobubble.
 */
// function openBubble(position, text){
//  if(!bubble){
//     bubble =  new H.ui.InfoBubble(
//       position,
//       // The FO property holds the province name.
//       {content: text});
//     ui.addBubble(bubble);
//   } else {
//     bubble.setPosition(position);
//     bubble.setContent(text);
//     bubble.open();
//   }
// }


/**
 * Creates a H.map.Polyline from the shape of the route and adds it to the map.
 * @param {Object} route A route as received from the H.service.RoutingService
 */
function addRouteShapeToMap(route){
  var lineString = new H.geo.LineString(),
    routeShape = route.shape,
    polyline;

  routeShape.forEach(function(point) {
    var parts = point.split(',');
    lineString.pushLatLngAlt(parts[0], parts[1]);
  });

  polyline = new H.map.Polyline(lineString, {
    style: {
      lineWidth: 4,
      strokeColor: 'rgba(0, 128, 255, 0.7)'
    }
  });
  polyline.id = "route";
  // Add the polyline to the map
  map.addObject(polyline);
  // And zoom to its bounding rectangle
  map.setViewBounds(polyline.getBounds(), true);
}
function removeObjectById(id){
   for (object of map.getObjects()){
    if (object.id===id){
        map.removeObject(object);
        }
    }
}

/**
 * Creates a series of H.map.Marker points from the route and adds them to the map.
 * @param {Object} route  A route as received from the H.service.RoutingService
 */
// function addManueversToMap(route){
//   var svgMarkup = '<svg width="18" height="18" ' +
//     'xmlns="http://www.w3.org/2000/svg">' +
//     '<circle cx="8" cy="8" r="8" ' +
//       'fill="#1b468d" stroke="white" stroke-width="1"  />' +
//     '</svg>',
//     dotIcon = new H.map.Icon(svgMarkup, {anchor: {x:8, y:8}}),
//     group = new  H.map.Group(),
//     i,
//     j;

//   // Add a marker for each maneuver
//   for (i = 0;  i < route.leg.length; i += 1) {
//     for (j = 0;  j < route.leg[i].maneuver.length; j += 1) {
//       // Get the next maneuver.
//       maneuver = route.leg[i].maneuver[j];
//       // Add a marker to the maneuvers group
//       var marker =  new H.map.Marker({
//         lat: maneuver.position.latitude,
//         lng: maneuver.position.longitude} ,
//         {icon: dotIcon});
//       marker.instruction = maneuver.instruction;
//       group.addObject(marker);
//     }
//   }

//   group.addEventListener('tap', function (evt) {
//     map.setCenter(evt.target.getPosition());
//     openBubble(
//        evt.target.getPosition(), evt.target.instruction);
//   }, false);

//   // Add the maneuvers group to the map
//   map.addObject(group);
// }


/**
 * Creates a series of H.map.Marker points from the route and adds them to the map.
 * @param {Object} route  A route as received from the H.service.RoutingService
 */
// function addWaypointsToPanel(waypoints){



//   var nodeH3 = document.createElement('h3'),
//     waypointLabels = [],
//     i;


//    for (i = 0;  i < waypoints.length; i += 1) {
//     waypointLabels.push(waypoints[i].label)
//    }

//    nodeH3.textContent = waypointLabels.join(' - ');

//   routeInstructionsContainer.innerHTML = '';
//   routeInstructionsContainer.appendChild(nodeH3);
// }

/**
 * Creates a series of H.map.Marker points from the route and adds them to the map.
 * @param {Object} route  A route as received from the H.service.RoutingService
 */
// function addSummaryToPanel(summary){
//   var summaryDiv = document.createElement('div'),
//    content = '';
//    content += '<b>Total distance</b>: ' + summary.distance  + 'm. <br/>';
//    content += '<b>Travel Time</b>: ' + summary.travelTime.toMMSS() + ' (in current traffic)';


//   summaryDiv.style.fontSize = 'small';
//   summaryDiv.style.marginLeft ='5%';
//   summaryDiv.style.marginRight ='5%';
//   summaryDiv.innerHTML = content;
//   routeInstructionsContainer.appendChild(summaryDiv);
// }

/**
 * Creates a series of H.map.Marker points from the route and adds them to the map.
 * @param {Object} route  A route as received from the H.service.RoutingService
 */
// function addManueversToPanel(route){



//   var nodeOL = document.createElement('ol'),
//     i,
//     j;

//   nodeOL.style.fontSize = 'small';
//   nodeOL.style.marginLeft ='5%';
//   nodeOL.style.marginRight ='5%';
//   nodeOL.className = 'directions';

//      // Add a marker for each maneuver
//   for (i = 0;  i < route.leg.length; i += 1) {
//     for (j = 0;  j < route.leg[i].maneuver.length; j += 1) {
//       // Get the next maneuver.
//       maneuver = route.leg[i].maneuver[j];

//       var li = document.createElement('li'),
//         spanArrow = document.createElement('span'),
//         spanInstruction = document.createElement('span');

//       spanArrow.className = 'arrow '  + maneuver.action;
//       spanInstruction.innerHTML = maneuver.instruction;
//       li.appendChild(spanArrow);
//       li.appendChild(spanInstruction);

//       nodeOL.appendChild(li);
//     }
//   }

//   routeInstructionsContainer.appendChild(nodeOL);
// }


// Number.prototype.toMMSS = function () {
//   return  Math.floor(this / 60)  +' minutes '+ (this % 60)  + ' seconds.';
// }

// Now use the map as required...


function transformCoordinates(coordinates){
  //here we go
  var diluted = [];
  if (coordinates.length > 30) {
    ratio = coordinates.length/30;
    for (var i = 0; i < 30; i++) {
      diluted.push(coordinates[Math.floor(i*ratio)])
    }
  } else {
    diluted = diluted = coordinates;
  }
  return diluted.map(coord => coord.split(',').map(x => parseFloat(x)))
  .map(val => ({'latitude': val[0], 'longitude': val[1]}));
}

function getAltitude(coordinates, distance){
  var request = {'locations': coordinates};
  axios.post('https://api.open-elevation.com/api/v1/lookup', request)
    .then(function (response) {
      var data = response.data.results.map(coord => ({'alt': coord.elevation}));
      drawGraph(data, distance);
      console.log('redraw');
      //document.getElementById('map').style="position:absolute; width:99%; height:70%; z-index:10;";
    })
    .catch(function (error) {
      console.log(error);
    });
}

  </script>
</body>
</html>